<!DOCTYPE html>
<html lang="zh-Hans">

<!-- Head tag -->
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!--Description-->
    
        <meta name="description" content="è§£è¡£åˆä½œèŒ¶ç“œå®¢ï¼Œå€šæ§›åŒçœ‹çƒŸé›¨å³°">
    

    <!--Author-->
    
        <meta name="author" content="èŒ¶ç“œå®¢">
    

    <!-- Title -->
    
    <title>smallpt | èŒ¶ç“œå®¢</title>

    <!-- Bootstrap Core CSS -->
    <link href="//cdn.bootcss.com/bootstrap/3.3.6/css/bootstrap.min.css" rel="stylesheet">

    <!-- Custom CSS -->
    
<link rel="stylesheet" href="/css/style.css">


    <!-- Custom Fonts -->
    <link href="//cdn.bootcss.com/font-awesome/4.5.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">
    <link href='//fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/css'>
    <link href='//fonts.googleapis.com/css?family=Noto+Serif:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/css'>

    <!-- jQuery -->
    <script src="//cdn.bootcss.com/jquery/2.2.1/jquery.min.js"></script>
    <!-- Bootstrap -->
    <script src="//cdn.bootcss.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
    <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->
<meta name="generator" content="Hexo 5.4.0"><link rel="alternate" href="/atom.xml" title="èŒ¶ç“œå®¢" type="application/atom+xml">
</head>

<body>

    <!-- Content -->
    <section class="article-container">
    <!-- Back Home -->
    <a class="nav-back" href="/">
    <i class="fa fa-puzzle-piece"></i>
</a>

        <!-- Page Header -->
        <header class="intro-header">
            <div class="container">
                <div class="row">
                    <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                        <div class="post-heading">
                            <h1>
                                smallpt
                            </h1>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <!-- Post Content -->
        <article>
            <div class="container">
                <div class="row">
                    <!-- Post Main Content -->
                    <div class="post-content col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                        <p>smallptæ˜¯ä¸€ä¸ªC++å®ç°çš„ç»å…¸å…‰çº¿è¿½è¸ªä»£ç ï¼Œåªæœ‰99è¡Œã€‚</p>
<span id="more"></span>
<p>åŸæ–‡ï¼š<a target="_blank" rel="noopener" href="http://www.kevinbeason.com/smallpt/">http://www.kevinbeason.com/smallpt/</a></p>
<p>ç¿»è¯‘ï¼š<a target="_blank" rel="noopener" href="https://samuel92.blog.csdn.net/article/details/108189198">https://samuel92.blog.csdn.net/article/details/108189198</a></p>
<p>æ–‡ç« ï¼š<a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/148759248">https://zhuanlan.zhihu.com/p/148759248</a></p>
<p align="center">
    <img src="http://www.kevinbeason.com/smallpt/result_25k.png" width="95%">
    <br />    <small> global illumination renderer </small>
</p>


<p>smallpt æ˜¯ä¸€ä¸ªå…¨å±€å…‰ç…§æ¸²æŸ“å™¨ï¼ŒåŸºäºæ— åè’™ç‰¹å¡æ´›è·¯å¾„è¿½è¸ªç®—æ³•ã€‚</p>
<blockquote>
<p>é¦–å…ˆï¼Œè’™ç‰¹å¡æ´›è·¯å¾„è¿½è¸ªç®—æ³•çŸ¥è¯†å¯çœ‹GAMES101æ•™ç¨‹çš„ç¬¬16èŠ‚ã€‚ç„¶åï¼Œæ— åä¼°è®¡çš„æ„ä¹‰æ˜¯ï¼šåœ¨å¤šæ¬¡é‡å¤ä¸‹ï¼Œå®ƒä»¬çš„å¹³å‡æ•°æ¥è¿‘æ‰€ä¼°è®¡çš„å‚æ•°çœŸå€¼ã€‚</p>
</blockquote>
<h2 id="ä¸€ã€ç‰¹å¾"><a href="#ä¸€ã€ç‰¹å¾" class="headerlink" title="ä¸€ã€ç‰¹å¾"></a>ä¸€ã€ç‰¹å¾</h2><ul>
<li>åŸºäºæ— åè’™ç‰¹å¡ç½—è·¯å¾„è·Ÿè¸ªçš„å…¨å±€ç…§æ˜ã€‚</li>
<li>å¤šçº¿ç¨‹ä½¿ç”¨OpenMPã€‚</li>
<li>æ¼«åå°„çš„è½¯é˜´å½±ã€‚</li>
<li>é•œé¢åå°„ã€æ¼«åå°„å’Œç»ç’ƒBRDFã€‚</li>
<li>é€šè¿‡é‡è¦æ€§é‡‡æ ·çš„è¶…é‡‡æ ·ï¼ˆ2x2å­åƒç´ ï¼‰æ¥æŠ—é”¯é½¿ã€‚</li>
<li>å°„çº¿çƒäº¤ç‚¹ã€‚</li>
<li>åœºæ™¯ä½¿ç”¨æ”¹è¿›çš„Cornell boxã€‚</li>
<li>åŠçƒæ¼«åå°„çš„ä½™å¼¦é‡è¦æ€§é‡‡æ ·ã€‚</li>
<li>ä¿„ç½—æ–¯è½®ç›˜èµŒå®ç°è·¯å¾„ç»ˆæ­¢ã€‚</li>
<li>ä¿„ç½—æ–¯è½®ç›˜èµŒå’Œåˆ†å‰²ï¼Œç”¨äºé€‰æ‹©ç»ç’ƒBRDFçš„åå°„å’Œï¼ˆæˆ–ï¼‰æŠ˜å°„ã€‚</li>
<li>æ˜¾å¼ç¯å…‰é‡‡æ ·å’Œéåˆ†æ”¯å…‰çº¿æ ‘ã€‚</li>
<li>CUDAå’ŒBSGPçš„ç«¯å£å…·æœ‰äº¤äº’å¼æ˜¾ç¤ºå’Œåœºæ™¯ç¼–è¾‘åŠŸèƒ½ã€‚</li>
</ul>
<h2 id="äºŒã€æºç "><a href="#äºŒã€æºç " class="headerlink" title="äºŒã€æºç "></a>äºŒã€æºç </h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><span class="line">#include &lt;math.h&gt;   &#x2F;&#x2F; smallpt, a Path Tracer by Kevin Beason, 2008</span><br><span class="line">#include &lt;stdlib.h&gt; &#x2F;&#x2F; Make : g++ -O3 -fopenmp smallpt.cpp -o smallpt</span><br><span class="line">#include &lt;stdio.h&gt;  &#x2F;&#x2F;        Remove &quot;-fopenmp&quot; for g++ version &lt; 4.2</span><br><span class="line">struct Vec &#123;        &#x2F;&#x2F; Usage: time .&#x2F;smallpt 5000 &amp;&amp; xv image.ppm</span><br><span class="line">  double x, y, z;                  &#x2F;&#x2F; position, also color (r,g,b)</span><br><span class="line">  Vec(double x_&#x3D;0, double y_&#x3D;0, double z_&#x3D;0)&#123; x&#x3D;x_; y&#x3D;y_; z&#x3D;z_; &#125;</span><br><span class="line">  Vec operator+(const Vec &amp;b) const &#123; return Vec(x+b.x,y+b.y,z+b.z); &#125;</span><br><span class="line">  Vec operator-(const Vec &amp;b) const &#123; return Vec(x-b.x,y-b.y,z-b.z); &#125;</span><br><span class="line">  Vec operator*(double b) const &#123; return Vec(x*b,y*b,z*b); &#125;</span><br><span class="line">  Vec mult(const Vec &amp;b) const &#123; return Vec(x*b.x,y*b.y,z*b.z); &#125;</span><br><span class="line">  Vec&amp; norm()&#123; return *this &#x3D; *this * (1&#x2F;sqrt(x*x+y*y+z*z)); &#125;</span><br><span class="line">  double dot(const Vec &amp;b) const &#123; return x*b.x+y*b.y+z*b.z; &#125; &#x2F;&#x2F; cross:</span><br><span class="line">  Vec operator%(Vec&amp;b)&#123;return Vec(y*b.z-z*b.y,z*b.x-x*b.z,x*b.y-y*b.x);&#125;</span><br><span class="line">&#125;;</span><br><span class="line">struct Ray &#123; Vec o, d; Ray(Vec o_, Vec d_) : o(o_), d(d_) &#123;&#125; &#125;;</span><br><span class="line">enum Refl_t &#123; DIFF, SPEC, REFR &#125;;  &#x2F;&#x2F; material types, used in radiance()</span><br><span class="line">struct Sphere &#123;</span><br><span class="line">  double rad;       &#x2F;&#x2F; radius</span><br><span class="line">  Vec p, e, c;      &#x2F;&#x2F; position, emission, color</span><br><span class="line">  Refl_t refl;      &#x2F;&#x2F; reflection type (DIFFuse, SPECular, REFRactive)</span><br><span class="line">  Sphere(double rad_, Vec p_, Vec e_, Vec c_, Refl_t refl_):</span><br><span class="line">    rad(rad_), p(p_), e(e_), c(c_), refl(refl_) &#123;&#125;</span><br><span class="line">  double intersect(const Ray &amp;r) const &#123; &#x2F;&#x2F; returns distance, 0 if nohit</span><br><span class="line">    Vec op &#x3D; p-r.o; &#x2F;&#x2F; Solve t^2*d.d + 2*t*(o-p).d + (o-p).(o-p)-R^2 &#x3D; 0</span><br><span class="line">    double t, eps&#x3D;1e-4, b&#x3D;op.dot(r.d), det&#x3D;b*b-op.dot(op)+rad*rad;</span><br><span class="line">    if (det&lt;0) return 0; else det&#x3D;sqrt(det);</span><br><span class="line">    return (t&#x3D;b-det)&gt;eps ? t : ((t&#x3D;b+det)&gt;eps ? t : 0);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line">Sphere spheres[] &#x3D; &#123;&#x2F;&#x2F;Scene: radius, position, emission, color, material</span><br><span class="line">  Sphere(1e5, Vec( 1e5+1,40.8,81.6), Vec(),Vec(.75,.25,.25),DIFF),&#x2F;&#x2F;Left</span><br><span class="line">  Sphere(1e5, Vec(-1e5+99,40.8,81.6),Vec(),Vec(.25,.25,.75),DIFF),&#x2F;&#x2F;Rght</span><br><span class="line">  Sphere(1e5, Vec(50,40.8, 1e5),     Vec(),Vec(.75,.75,.75),DIFF),&#x2F;&#x2F;Back</span><br><span class="line">  Sphere(1e5, Vec(50,40.8,-1e5+170), Vec(),Vec(),           DIFF),&#x2F;&#x2F;Frnt</span><br><span class="line">  Sphere(1e5, Vec(50, 1e5, 81.6),    Vec(),Vec(.75,.75,.75),DIFF),&#x2F;&#x2F;Botm</span><br><span class="line">  Sphere(1e5, Vec(50,-1e5+81.6,81.6),Vec(),Vec(.75,.75,.75),DIFF),&#x2F;&#x2F;Top</span><br><span class="line">  Sphere(16.5,Vec(27,16.5,47),       Vec(),Vec(1,1,1)*.999, SPEC),&#x2F;&#x2F;Mirr</span><br><span class="line">  Sphere(16.5,Vec(73,16.5,78),       Vec(),Vec(1,1,1)*.999, REFR),&#x2F;&#x2F;Glas</span><br><span class="line">  Sphere(600, Vec(50,681.6-.27,81.6),Vec(12,12,12),  Vec(), DIFF) &#x2F;&#x2F;Lite</span><br><span class="line">&#125;;</span><br><span class="line">inline double clamp(double x)&#123; return x&lt;0 ? 0 : x&gt;1 ? 1 : x; &#125;</span><br><span class="line">inline int toInt(double x)&#123; return int(pow(clamp(x),1&#x2F;2.2)*255+.5); &#125;</span><br><span class="line">inline bool intersect(const Ray &amp;r, double &amp;t, int &amp;id)&#123;</span><br><span class="line">  double n&#x3D;sizeof(spheres)&#x2F;sizeof(Sphere), d, inf&#x3D;t&#x3D;1e20;</span><br><span class="line">  for(int i&#x3D;int(n);i--;) if((d&#x3D;spheres[i].intersect(r))&amp;&amp;d&lt;t)&#123;t&#x3D;d;id&#x3D;i;&#125;</span><br><span class="line">  return t&lt;inf;</span><br><span class="line">&#125;</span><br><span class="line">Vec radiance(const Ray &amp;r, int depth, unsigned short *Xi)&#123;</span><br><span class="line">  double t;                               &#x2F;&#x2F; distance to intersection</span><br><span class="line">  int id&#x3D;0;                               &#x2F;&#x2F; id of intersected object</span><br><span class="line">  if (!intersect(r, t, id)) return Vec(); &#x2F;&#x2F; if miss, return black</span><br><span class="line">  const Sphere &amp;obj &#x3D; spheres[id];        &#x2F;&#x2F; the hit object</span><br><span class="line">  Vec x&#x3D;r.o+r.d*t, n&#x3D;(x-obj.p).norm(), nl&#x3D;n.dot(r.d)&lt;0?n:n*-1, f&#x3D;obj.c;</span><br><span class="line">  double p &#x3D; f.x&gt;f.y &amp;&amp; f.x&gt;f.z ? f.x : f.y&gt;f.z ? f.y : f.z; &#x2F;&#x2F; max refl</span><br><span class="line">  if (++depth&gt;5) if (erand48(Xi)&lt;p) f&#x3D;f*(1&#x2F;p); else return obj.e; &#x2F;&#x2F;R.R.</span><br><span class="line">  if (obj.refl &#x3D;&#x3D; DIFF)&#123;                  &#x2F;&#x2F; Ideal DIFFUSE reflection</span><br><span class="line">    double r1&#x3D;2*M_PI*erand48(Xi), r2&#x3D;erand48(Xi), r2s&#x3D;sqrt(r2);</span><br><span class="line">    Vec w&#x3D;nl, u&#x3D;((fabs(w.x)&gt;.1?Vec(0,1):Vec(1))%w).norm(), v&#x3D;w%u;</span><br><span class="line">    Vec d &#x3D; (u*cos(r1)*r2s + v*sin(r1)*r2s + w*sqrt(1-r2)).norm();</span><br><span class="line">    return obj.e + f.mult(radiance(Ray(x,d),depth,Xi));</span><br><span class="line">  &#125; else if (obj.refl &#x3D;&#x3D; SPEC)            &#x2F;&#x2F; Ideal SPECULAR reflection</span><br><span class="line">    return obj.e + f.mult(radiance(Ray(x,r.d-n*2*n.dot(r.d)),depth,Xi));</span><br><span class="line">  Ray reflRay(x, r.d-n*2*n.dot(r.d));     &#x2F;&#x2F; Ideal dielectric REFRACTION</span><br><span class="line">  bool into &#x3D; n.dot(nl)&gt;0;                &#x2F;&#x2F; Ray from outside going in?</span><br><span class="line">  double nc&#x3D;1, nt&#x3D;1.5, nnt&#x3D;into?nc&#x2F;nt:nt&#x2F;nc, ddn&#x3D;r.d.dot(nl), cos2t;</span><br><span class="line">  if ((cos2t&#x3D;1-nnt*nnt*(1-ddn*ddn))&lt;0)    &#x2F;&#x2F; Total internal reflection</span><br><span class="line">    return obj.e + f.mult(radiance(reflRay,depth,Xi));</span><br><span class="line">  Vec tdir &#x3D; (r.d*nnt - n*((into?1:-1)*(ddn*nnt+sqrt(cos2t)))).norm();</span><br><span class="line">  double a&#x3D;nt-nc, b&#x3D;nt+nc, R0&#x3D;a*a&#x2F;(b*b), c &#x3D; 1-(into?-ddn:tdir.dot(n));</span><br><span class="line">  double Re&#x3D;R0+(1-R0)*c*c*c*c*c,Tr&#x3D;1-Re,P&#x3D;.25+.5*Re,RP&#x3D;Re&#x2F;P,TP&#x3D;Tr&#x2F;(1-P);</span><br><span class="line">  return obj.e + f.mult(depth&gt;2 ? (erand48(Xi)&lt;P ?   &#x2F;&#x2F; Russian roulette</span><br><span class="line">    radiance(reflRay,depth,Xi)*RP:radiance(Ray(x,tdir),depth,Xi)*TP) :</span><br><span class="line">    radiance(reflRay,depth,Xi)*Re+radiance(Ray(x,tdir),depth,Xi)*Tr);</span><br><span class="line">&#125;</span><br><span class="line">int main(int argc, char *argv[])&#123;</span><br><span class="line">  int w&#x3D;1024, h&#x3D;768, samps &#x3D; argc&#x3D;&#x3D;2 ? atoi(argv[1])&#x2F;4 : 1; &#x2F;&#x2F; # samples</span><br><span class="line">  Ray cam(Vec(50,52,295.6), Vec(0,-0.042612,-1).norm()); &#x2F;&#x2F; cam pos, dir</span><br><span class="line">  Vec cx&#x3D;Vec(w*.5135&#x2F;h), cy&#x3D;(cx%cam.d).norm()*.5135, r, *c&#x3D;new Vec[w*h];</span><br><span class="line">#pragma omp parallel for schedule(dynamic, 1) private(r)       &#x2F;&#x2F; OpenMP</span><br><span class="line">  for (int y&#x3D;0; y&lt;h; y++)&#123;                       &#x2F;&#x2F; Loop over image rows</span><br><span class="line">    fprintf(stderr,&quot;\rRendering (%d spp) %5.2f%%&quot;,samps*4,100.*y&#x2F;(h-1));</span><br><span class="line">    for (unsigned short x&#x3D;0, Xi[3]&#x3D;&#123;0,0,y*y*y&#125;; x&lt;w; x++)   &#x2F;&#x2F; Loop cols</span><br><span class="line">      for (int sy&#x3D;0, i&#x3D;(h-y-1)*w+x; sy&lt;2; sy++)     &#x2F;&#x2F; 2x2 subpixel rows</span><br><span class="line">        for (int sx&#x3D;0; sx&lt;2; sx++, r&#x3D;Vec())&#123;        &#x2F;&#x2F; 2x2 subpixel cols</span><br><span class="line">          for (int s&#x3D;0; s&lt;samps; s++)&#123;</span><br><span class="line">            double r1&#x3D;2*erand48(Xi), dx&#x3D;r1&lt;1 ? sqrt(r1)-1: 1-sqrt(2-r1);</span><br><span class="line">            double r2&#x3D;2*erand48(Xi), dy&#x3D;r2&lt;1 ? sqrt(r2)-1: 1-sqrt(2-r2);</span><br><span class="line">            Vec d &#x3D; cx*( ( (sx+.5 + dx)&#x2F;2 + x)&#x2F;w - .5) +</span><br><span class="line">                    cy*( ( (sy+.5 + dy)&#x2F;2 + y)&#x2F;h - .5) + cam.d;</span><br><span class="line">            r &#x3D; r + radiance(Ray(cam.o+d*140,d.norm()),0,Xi)*(1.&#x2F;samps);</span><br><span class="line">          &#125; &#x2F;&#x2F; Camera rays are pushed ^^^^^ forward to start in interior</span><br><span class="line">          c[i] &#x3D; c[i] + Vec(clamp(r.x),clamp(r.y),clamp(r.z))*.25;</span><br><span class="line">        &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  FILE *f &#x3D; fopen(&quot;image.ppm&quot;, &quot;w&quot;);         &#x2F;&#x2F; Write image to PPM file.</span><br><span class="line">  fprintf(f, &quot;P3\n%d %d\n%d\n&quot;, w, h, 255);</span><br><span class="line">  for (int i&#x3D;0; i&lt;w*h; i++)</span><br><span class="line">    fprintf(f,&quot;%d %d %d &quot;, toInt(c[i].x), toInt(c[i].y), toInt(c[i].z));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="ä¸‰ã€ç”¨æ³•"><a href="#ä¸‰ã€ç”¨æ³•" class="headerlink" title="ä¸‰ã€ç”¨æ³•"></a>ä¸‰ã€ç”¨æ³•</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">g++ -O3 -fopenmp smallpt.cpp -o smallpt </span><br><span class="line">time .&#x2F;smallpt 5000</span><br><span class="line">display image.ppm</span><br></pre></td></tr></table></figure>
<h2 id="å››ã€ç»†èŠ‚"><a href="#å››ã€ç»†èŠ‚" class="headerlink" title="å››ã€ç»†èŠ‚"></a>å››ã€ç»†èŠ‚</h2><p align="center">
    <img src="https://z3.ax1x.com/2021/08/06/fnD54K.png" width="95%">
    <br />    <small> 2.4 GHz ä¸¤æ ¸å››çº¿ç¨‹ï¼Œæ¯ä¸ªåƒç´ çš„ä¸åŒé‡‡æ ·æ•°ï¼ˆsppï¼‰çš„è®¡æ—¶å’Œç»“æœå›¾åƒ  </small>
</p>

<p>é€šè¿‡ä½¿ç”¨æ•°å€¼ç§¯åˆ†æ±‚è§£æ¸²æŸ“æ–¹ç¨‹æ¥è®¡ç®—å›¾åƒã€‚å…·ä½“çš„ç®—æ³•æ˜¯è’™ç‰¹å¡ç½—è·¯å¾„è·Ÿè¸ªä¸ä¿„ç½—æ–¯è½®ç›˜èµŒè·¯å¾„ç»ˆæ­¢ã€‚ç”±äºå°ºå¯¸é™åˆ¶å’Œç®€å•æ€§ï¼Œä¸ä½¿ç”¨æ˜¾å¼ç¯å…‰é‡‡æ ·ï¼Œä¹Ÿä¸ä½¿ç”¨ä»»ä½•å…‰çº¿ç›¸äº¤åŠ é€Ÿæ•°æ®ç»“æ„ã€‚</p>
<p><code>#pragma omp parallel for schedule(dynamic, 1) private(r)</code> è¯­å¥ï¼Œä½¿ç”¨OpenMPåŠ¨æ€åœ°å°†æ˜ åƒè¡Œåˆ†é…ç»™ä¸åŒçš„çº¿ç¨‹ï¼Œæ¯ä¸ªå¤„ç†å™¨æˆ–å†…æ ¸æœ‰ä¸€ä¸ªçº¿ç¨‹ã€‚</p>
<p>å˜é‡ <code>Xi</code> ç”¨äºå­˜å‚¨éšæœºæ•°ç”Ÿæˆå™¨  <code>erand48</code> çš„çŠ¶æ€ï¼Œä½¿ç”¨è¡Œæ•°æ¥åšéšæœºå€¼ç§å­ï¼Œè¿™æ ·å­åºåˆ—å°±æ˜¯è·Ÿè¡Œæ•°æœ‰å…³ï¼Œä¸å¹¶è¡Œè®¡ç®—çš„å…ˆåé¡ºåºç­‰æ— å…³ã€‚</p>
<p>æŠ—é”¯é½¿æ˜¯ä½¿ç”¨è¶…çº§é‡‡æ ·å®Œæˆçš„ï¼Œè¶…çº§é‡‡æ ·å°†åˆ é™¤é™¤ç¯å…‰å‘¨å›´ä»¥å¤–çš„æ‰€æœ‰é”¯é½¿ã€‚é€šè¿‡ä½¿ç”¨2x2å­åƒç´ è¿›è¡Œå¤„ç†ï¼Œè¿™äº›å­åƒç´ å…ˆè¢«clampæ“ä½œï¼Œç„¶åæ±‚å¹³å‡ã€‚</p>
<h2 id="äº”ã€æ‰©å±•"><a href="#äº”ã€æ‰©å±•" class="headerlink" title="äº”ã€æ‰©å±•"></a>äº”ã€æ‰©å±•</h2><p><strong>ï¼ˆä¸€ï¼‰Vec ç±»</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; å®šä¹‰</span><br><span class="line">struct Vec &#123;        &#x2F;&#x2F; Usage: time .&#x2F;smallpt 5000 &amp;&amp; xv image.ppm</span><br><span class="line">  double x, y, z;                  &#x2F;&#x2F; position, also color (r,g,b)</span><br><span class="line">  Vec(double x_&#x3D;0, double y_&#x3D;0, double z_&#x3D;0)&#123; x&#x3D;x_; y&#x3D;y_; z&#x3D;z_; &#125;</span><br><span class="line">  Vec operator+(const Vec &amp;b) const &#123; return Vec(x+b.x,y+b.y,z+b.z); &#125;</span><br><span class="line">  Vec operator-(const Vec &amp;b) const &#123; return Vec(x-b.x,y-b.y,z-b.z); &#125;</span><br><span class="line">  Vec operator*(double b) const &#123; return Vec(x*b,y*b,z*b); &#125;</span><br><span class="line">  Vec mult(const Vec &amp;b) const &#123; return Vec(x*b.x,y*b.y,z*b.z); &#125;</span><br><span class="line">  Vec&amp; norm()&#123; return *this &#x3D; *this * (1&#x2F;sqrt(x*x+y*y+z*z)); &#125;</span><br><span class="line">  double dot(const Vec &amp;b) const &#123; return x*b.x+y*b.y+z*b.z; &#125; &#x2F;&#x2F; cross:</span><br><span class="line">  Vec operator%(Vec&amp;b)&#123;return Vec(y*b.z-z*b.y,z*b.x-x*b.z,x*b.y-y*b.x);&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; åº”ç”¨</span><br><span class="line">Vec cx&#x3D;Vec(w*.5135&#x2F;h), cy&#x3D;(cx%cam.d).norm()*.5135, r, *c&#x3D;new Vec[w*h];</span><br></pre></td></tr></table></figure>
<p>Vec ç±»å®ç°äº†å‘é‡çš„è¿ç®—ã€‚</p>
<p>æˆå‘˜ norm å‡½æ•°çš„è®¡ç®—å…¬å¼å…¶å®æ˜¯å°†ä¸‰ä¸ªåˆ†é‡åˆ†åˆ«ä¹˜ä»¥æ¯”ä¾‹ç³»æ•°ï¼Œä»è€Œè¾¾åˆ°å½’ä¸€åŒ–æ“ä½œã€‚</p>
<p>æˆå‘˜ dot å‡½æ•°å¯¹åº”çš„æ˜¯å‘é‡çš„ç‚¹ä¹˜è¿ç®—ï¼š</p>
<script type="math/tex; mode=display">
\vec{a} \cdot \vec{b} = 

\begin{pmatrix}
x_{a} \\ y_{a} \\ z_{a}
\end{pmatrix}

\cdot

\begin{pmatrix}
x_{b} \\ y_{b} \\ z_{b}
\end{pmatrix}

=

x_{a}x_{b} + y_{a}y_{b} + z_{a}z_{b}</script><p>% æ“ä½œè¿ç®—ç¬¦å¯¹åº”çš„æ˜¯å‘é‡çš„å‰ä¹˜è¿ç®—ï¼š</p>
<script type="math/tex; mode=display">
\vec{a} \times \vec{b} = 

\begin{pmatrix}
x_{a} \\
y_{a} \\
z_{a} 
\end{pmatrix}

\times

\begin{pmatrix}
x_{b} \\
y_{b} \\
z_{b} 
\end{pmatrix}

=

\begin{pmatrix}
y_{a}z_{b} - y_{b}z_{a} \\
z_{a}x_{b} - x_{a}z_{b} \\
x_{a}y_{b} - y_{a}x_{b}
\end{pmatrix}</script><script type="math/tex; mode=display">
\vec{a} \times \vec{b} = A^{*}b = 
\underset{\text{dual matrix of vector a}}{
\begin{pmatrix}
0 & -z_{a} & y_{a} \\
z_{a} & 0 & -x_{a} \\
-y_{a} & x_{a} & 0
\end{pmatrix} 
}

\begin{pmatrix}
x_{b} \\
y_{b} \\
z_{b} 
\end{pmatrix}</script><p>åº”ç”¨ä¸Šï¼Œå˜é‡ cx ä¸ºæ‘„åƒæœºåœ¨ x è½´ä¸Šçš„æ–¹å‘åˆ†é‡ï¼ˆå³è½´ï¼‰ï¼ŒåŒç†å˜é‡ cy æ˜¯æ‘„åƒæœºåœ¨ y è½´ä¸Šçš„æ–¹å‘åˆ†é‡ï¼ˆä¸Šè½´ï¼‰ã€‚0.5135æ˜¯è§†åœºç³»æ•°ï¼Œæ§åˆ¶æ‘„åƒæœºçœ‹åˆ°çš„èŒƒå›´ï¼Œå˜é‡ cx é€šè¿‡å¯¹è¾“å‡ºå›¾åƒçš„åˆ†è¾¨ç‡æ¯”ä¾‹æ±‚å¾—ï¼Œè€Œå˜é‡ cy æ˜¯é€šè¿‡æ‘„åƒæœºæ–¹å‘å’Œå˜é‡ cx å‰ä¹˜å¾—åˆ°ï¼ˆè§ï¼š<a target="_blank" rel="noopener" href="https://learnopengl-cn.github.io/01%20Getting%20started/09%20Camera/">LearnOpenGL-æ‘„åƒæœº</a>ï¼‰ã€‚</p>
<p>å˜é‡ r æ˜¯å½“å‰åƒç´ ç‚¹çš„å…‰ç…§è¾å°„å€¼ï¼Œé€šè¿‡å¯¹å­åƒç´ ç‚¹è®¡ç®—ç´¯åŠ æ±‚å¾—ã€‚</p>
<p>å˜é‡ c æ˜¯è¾“å‡ºå›¾åƒçš„æ•°æ®æ•°ç»„ï¼Œè®°å½•æ¯ä¸ªåƒç´ ç‚¹çš„é¢œè‰²å€¼ã€‚</p>
<p><strong>ï¼ˆäºŒï¼‰main å‡½æ•°çš„5ä¸ª for å¾ªç¯</strong></p>
<ol>
<li>ç¬¬ä¸€ä¸ª for å¾ªç¯</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">for (int y&#x3D;0; y&lt;h; y++)</span><br></pre></td></tr></table></figure>
<p>éå†è¾“å‡ºåƒç´ åˆ†è¾¨ç‡çš„æ¯ä¸€è¡Œã€‚</p>
<ol>
<li>ç¬¬äºŒä¸ª for å¾ªç¯</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">for (unsigned short x&#x3D;0, Xi[3]&#x3D;&#123;0,0,y*y*y&#125;; x&lt;w; x++)</span><br></pre></td></tr></table></figure>
<p>éå†æ¯ä¸€è¡Œåˆ†è¾¨ç‡çš„æ¯ä¸€ä¸ªåƒç´ ï¼ˆæ¯ä¸€åˆ—ï¼‰ã€‚</p>
<ol>
<li>ç¬¬ä¸‰ä¸ª for å¾ªç¯</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">for (int sy&#x3D;0, i&#x3D;(h-y-1)*w+x; sy&lt;2; sy++)</span><br></pre></td></tr></table></figure>
<p>ä»å³ä¸‹è§’å¼€å§‹ï¼Œç”±äºé‡‡ç”¨çš„æ˜¯2x2è¶…çº§é‡‡æ ·ï¼Œæ‰€ä»¥æ¯ä¸ªåƒç´ åˆ†ä¸ºå››ä¸ªå­åƒç´ ã€‚è¿™ä¸€å±‚å¯¹åº”æ¯ä¸ªåƒç´ ã€‚</p>
<ol>
<li>ç¬¬å››ä¸ª for å¾ªç¯</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">for (int sx&#x3D;0; sx&lt;2; sx++, r&#x3D;Vec())</span><br></pre></td></tr></table></figure>
<p>ç”±äºé‡‡ç”¨çš„æ˜¯2x2è¶…çº§é‡‡æ ·ï¼Œæ‰€ä»¥æ¯ä¸ªåƒç´ åˆ†ä¸ºå››ä¸ªå­åƒç´ ã€‚è¿™ä¸€å±‚å¯¹åº”æ¯ä¸ªå­åƒç´ ã€‚</p>
<p>è¿™ä¸€å±‚ä¸»è¦åšä¸¤ä»¶äº‹æƒ…ï¼Œå¤šæ¬¡é‡‡æ ·ä»¥åŠå°†æ¯ä¸€ä¸ªå­åƒç´ è®¡ç®—ç»“æœç´¯åŠ åˆ°è¯¥åƒç´ ç‚¹çš„æ•°å€¼ä¸Šã€‚</p>
<ol>
<li>ç¬¬äº”ä¸ª for å¾ªç¯</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">for (int s&#x3D;0; s&lt;samps; s++)</span><br></pre></td></tr></table></figure>
<p>æ¯ä¸ªå­åƒç´ é‡‡æ · samps æ¬¡ã€‚</p>
<p>åœ¨è¯¥å¾ªç¯ä¸­ï¼Œé¦–å…ˆé‡‡ç”¨ Tent Filter å®ç°æŠ—é”¯é½¿ï¼Œç„¶åè®¡ç®—è¯¥å­åƒç´ ç‚¹çš„å…‰çº¿æ–¹å‘ dï¼Œæœ€åæ±‚å¾—è¯¥å­åƒç´ ç‚¹çš„è¾å°„å€¼ï¼Œå¹¶ç´¯åŠ åˆ°åƒç´ ç‚¹çš„è¾å°„å€¼å˜é‡ r ä¸Šã€‚</p>
<p><strong>ï¼ˆä¸‰ï¼‰Tent Filter</strong></p>
<p>å…ˆçœ‹ Tent Filter çš„å‡½æ•°å®šä¹‰ï¼š</p>
<script type="math/tex; mode=display">
f_{tent}(x) = \begin{cases}
1- \vert x \vert , &  \vert x \vert < 1 \\[2ex]
0,  & \text{otherwise}
\end{cases}</script><p>ä½é€šæ»¤æ³¢ï¼Œåªè¾“å‡º x çš„ç»å¯¹å€¼å°äºæ—¶çš„ç»“æœï¼Œå†çœ‹ä»£ç çš„å®ç°æ–¹å¼ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">double r1&#x3D;2*erand48(Xi), dx&#x3D;r1&lt;1 ? sqrt(r1)-1: 1-sqrt(2-r1);</span><br><span class="line">double r2&#x3D;2*erand48(Xi), dy&#x3D;r2&lt;1 ? sqrt(r2)-1: 1-sqrt(2-r2);</span><br></pre></td></tr></table></figure>
<p>å˜é‡ r1 å’Œ r2 çš„å–å€¼åœ¨ $[0,2)$ï¼Œç„¶åå˜é‡ dx å’Œ dy çš„å–å€¼æ ¹æ® å˜é‡ r1 å’Œ r2 çš„å–å€¼ä¸åŒæœ‰ç€ä¸åŒçš„å–å€¼ï¼Œä½†æ€»ä½“èŒƒå›´åœ¨ $[-1,1]$ï¼š</p>
<script type="math/tex; mode=display">
d(r) =  \begin{cases}
\sqrt{r} - 1, &  0 \leq r < 1 \\[2ex]
1- \sqrt{2 - r},  &  1 \leq r < 2
\end{cases}</script><p>å¯ä»¥çœ‹åˆ°ä¸åŸç”Ÿ Tent Filter çš„å–å€¼èŒƒå›´ä¸åŒï¼Œå…ˆçœ‹ä¸‹æ€ä¹ˆä½¿ç”¨ç»“æœï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Vec d &#x3D; cx*( ( (sx+.5 + dx )&#x2F;2 + x)&#x2F;w - .5) +</span><br><span class="line">                    cy*( ( (sy+.5 + dy )&#x2F;2 + y)&#x2F;h - .5) + cam.d;</span><br></pre></td></tr></table></figure>
<p>å­åƒç´ çš„å…‰çº¿æ–¹å‘ d ä¸æ‘„åƒæœºåœ¨ xy è½´ä¸Šçš„æ–¹å‘åˆ†é‡ã€å½“å‰å­åƒç´ åºå·ä»¥åŠæ‘„åƒæœºçš„æ–¹å‘æœ‰å…³ã€‚<code>sx+.5</code> æˆ– <code>sy+.5</code> æ˜¯å°†é‡‡æ ·ç‚¹ç§»åŠ¨åˆ°å­åƒç´ çš„ä¸­å¿ƒç‚¹ï¼Œç„¶åå†åŠ ä¸Š Tent Filter å€¼ã€‚</p>
<p>æœ€ç»ˆï¼Œ<code>cx*( ( (sx+.5 + dx )/2 + x)/w - .5)</code> æˆ– <code>cy*( ( (sy+.5 + dy )/2 + y)/h - .5)</code> å¯¹åº”åˆ†é‡çš„å–å€¼èŒƒå›´åœ¨ $[-0.5,0.5)$ã€‚ä¹Ÿå°±æ˜¯åœ¨å½“å‰åƒç´ ç‚¹çš„é¢ç§¯å†…åšåç§»ã€‚</p>
<p><strong>ä¸Šé¢è§£é‡Šçš„æœ‰é—®é¢˜ï¼Œå¾—çœ‹ä¸‹é¢æˆªå›¾ï¼š</strong></p>
<p align="center">
    <img src="https://z3.ax1x.com/2021/08/09/f81oMd.png" width="95%">
    <br />    <small>  </small>
</p>

<p><strong>ï¼ˆå››ï¼‰OpenMP</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">#pragma omp parallel for schedule(dynamic, 1) private(r)</span><br></pre></td></tr></table></figure>
<p>å®ç°å¹¶è¡Œè®¡ç®—ã€‚</p>
<p><strong>ï¼ˆäº”ï¼‰Sphere ç±»</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">struct Sphere &#123;</span><br><span class="line">  double rad;       &#x2F;&#x2F; radius</span><br><span class="line">  Vec p, e, c;      &#x2F;&#x2F; position, emission, color</span><br><span class="line">  Refl_t refl;      &#x2F;&#x2F; reflection type (DIFFuse, SPECular, REFRactive)</span><br><span class="line">  Sphere(double rad_, Vec p_, Vec e_, Vec c_, Refl_t refl_):</span><br><span class="line">    rad(rad_), p(p_), e(e_), c(c_), refl(refl_) &#123;&#125;</span><br><span class="line">  double intersect(const Ray &amp;r) const &#123; &#x2F;&#x2F; returns distance, 0 if nohit</span><br><span class="line">    Vec op &#x3D; p-r.o; &#x2F;&#x2F; Solve t^2*d.d + 2*t*(o-p).d + (o-p).(o-p)-R^2 &#x3D; 0</span><br><span class="line">    double t, eps&#x3D;1e-4, b&#x3D;op.dot(r.d), det&#x3D;b*b-op.dot(op)+rad*rad;</span><br><span class="line">    if (det&lt;0) return 0; else det&#x3D;sqrt(det);</span><br><span class="line">    return (t&#x3D;b-det)&gt;eps ? t : ((t&#x3D;b+det)&gt;eps ? t : 0);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>å®šä¹‰åœºæ™¯å„ç§ç‰©ä½“çš„çƒä½“ç±»ã€‚</p>
<p>æˆå‘˜å˜é‡ rad å®šä¹‰çƒä½“åŠå¾„ï¼Œå˜é‡ p å®šä¹‰çƒå¿ƒä½ç½®ï¼Œå˜é‡ e å®šä¹‰ç‰©ä½“è‡ªå‘å…‰å±æ€§ï¼Œå˜é‡ c å®šä¹‰ç‰©ä½“é¢œè‰²ï¼Œç»“æ„ä½“å˜é‡ refl å®šä¹‰ç‰©ä½“æ•£å°„æ€§è´¨ï¼ˆæ¼«åå°„ã€é•œé¢åå°„ã€æŠ˜å°„ï¼‰ã€‚</p>
<p>æˆå‘˜ intersect å‡½æ•°åˆ¤æ–­ç‰©ä½“ä¸å…‰çº¿æ˜¯å¦ç›¸äº¤ï¼Œç›¸äº¤åˆ™è¿”å›äº¤ç‚¹ä¸å…‰çº¿åŸç‚¹çš„è·ç¦»ã€‚è€Œå…¶åˆ¤æ–­æ–¹æ³•ä¸º<a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/136763389">å‚æ•°æ–¹ç¨‹æ³•</a>ã€‚</p>
<p><strong>ï¼ˆå…­ï¼‰radiance å‡½æ•°</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Vec radiance(const Ray &amp;r, int depth, unsigned short *Xi)</span><br></pre></td></tr></table></figure>
<p>radiance å‡½æ•°æ¥å—ä¸‰ä¸ªå‚æ•°ï¼Œç¬¬ä¸€ä¸ªæ˜¯å…‰çº¿ï¼Œç¬¬äºŒä¸ªæ˜¯å…‰çº¿è¿½è¸ªçš„æ·±åº¦ï¼Œç¬¬ä¸‰ä¸ªæ˜¯éšæœºå€¼ç§å­ã€‚</p>
<p>åœ¨ main å‡½æ•°ä¸­è°ƒç”¨å¦‚ä¸‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">radiance(Ray(cam.o+d*140,d.norm()),0,Xi)</span><br></pre></td></tr></table></figure>
<p>å› ä¸ºé‡æ–°è®¡ç®—äº†å…‰çº¿çš„æ–¹å‘ï¼Œæ‰€ä»¥ä¼ å…¥åˆå§‹çš„å…‰çº¿ä½ç½®å’Œæ–¹å‘ä¹Ÿéœ€è¦å¯¹åº”æ”¹å˜ã€‚</p>
<ol>
<li>åˆ¤æ–­æ˜¯å¦ä¸ç‰©ä½“ç›¸äº¤ï¼Œå¦åˆ™ç›´æ¥è¿”å›</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">double t;                               &#x2F;&#x2F; distance to intersection</span><br><span class="line">int id&#x3D;0;                               &#x2F;&#x2F; id of intersected object</span><br><span class="line">if (!intersect(r, t, id)) return Vec(); &#x2F;&#x2F; if miss, return black</span><br></pre></td></tr></table></figure>
<p>å…¨å±€ intersect å‡½æ•°éå†æ¯ä¸€ä¸ªçƒä½“ç‰©ä½“ï¼Œç„¶ååˆ¤æ–­å…‰çº¿æ˜¯å¦ä¸å®ƒä»¬ç›¸äº¤ï¼Œå¹¶ä¸”è¿”å›æœ€è¿‘çš„ä¸€ä¸ªç‰©ä½“çš„äº¤ç‚¹è·ç¦»ã€‚</p>
<ol>
<li>è®¡ç®—/å®šä¹‰ä¸€äº›ç›¸äº¤ä¹‹åçš„ä¿¡æ¯</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">const Sphere &amp;obj &#x3D; spheres[id];        &#x2F;&#x2F; the hit object</span><br><span class="line">Vec x&#x3D;r.o+r.d*t, n&#x3D;(x-obj.p).norm(), nl&#x3D;n.dot(r.d)&lt;0?n:n*-1, f&#x3D;obj.c;</span><br></pre></td></tr></table></figure>
<p>å˜é‡ obj ä¸ºæœ¬æ¬¡å…‰çº¿è·¯å¾„è¿½è¸ªç›¸äº¤çš„ç‰©ä½“ã€‚</p>
<p>å˜é‡ x æ˜¯é€šè¿‡å…‰çº¿å‡½æ•°è¡¨è¾¾å¼è®¡ç®—å¾—åˆ°çš„äº¤ç‚¹åæ ‡ã€‚</p>
<p>å˜é‡ n æ˜¯ç‰©ä½“åœ¨äº¤ç‚¹ä¸Šçš„è¡¨é¢æ³•çº¿ã€‚</p>
<p>å˜é‡ nl æ˜¯æœå‘æ³•çº¿ï¼ˆoriented normalï¼‰ï¼Œé€šè¿‡è®¡ç®—å…‰çº¿æ–¹å‘ä¸ç‰©ä½“äº¤ç‚¹è¡¨é¢æ³•çº¿ä¹‹é—´çš„å¤¹è§’ä½™å¼¦å€¼ï¼Œåˆ¤æ–­å…¶æ­£è´Ÿæ¥å†³å®šå…‰çº¿æ˜¯æ‰“åœ¨ç‰©ä½“è¡¨é¢è¿˜æ˜¯ä»ç‰©ä½“å†…éƒ¨ç©¿å‡ºæ¥ã€‚</p>
<p>å˜é‡ f ä¸ºç‰©ä½“é¢œè‰²ã€‚</p>
<ol>
<li>ä¿„ç½—æ–¯è½®ç›˜èµŒï¼Œå†³å®šå…‰çº¿è¿½è¸ªæ˜¯å¦ç»“æŸ</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">double p &#x3D; f.x&gt;f.y &amp;&amp; f.x&gt;f.z ? f.x : f.y&gt;f.z ? f.y : f.z; &#x2F;&#x2F; max refl</span><br><span class="line">if (++depth&gt;5) if (erand48(Xi)&lt;p) f&#x3D;f*(1&#x2F;p); else return obj.e; &#x2F;&#x2F;R.R.</span><br></pre></td></tr></table></figure>
<p>å˜é‡ p æ˜¯å–å½“å‰ç‰©ä½“é¢œè‰²ä¸‰ä¸ªåˆ†é‡ä¸­çš„æœ€å¤§å€¼ã€‚</p>
<p>åªæœ‰åœ¨æ·±åº¦å¤§äº5ä¹‹åï¼Œæ‰è¿›è¡Œä¿„ç½—æ–¯è½®ç›˜èµŒã€‚</p>
<ol>
<li>è®¡ç®—æ¼«åå°„</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">if (obj.refl &#x3D;&#x3D; DIFF)&#123;                  &#x2F;&#x2F; Ideal DIFFUSE reflection</span><br><span class="line">    double r1&#x3D;2*M_PI*erand48(Xi), r2&#x3D;erand48(Xi), r2s&#x3D;sqrt(r2);</span><br><span class="line">    Vec w&#x3D;nl, u&#x3D;((fabs(w.x)&gt;.1?Vec(0,1):Vec(1))%w).norm(), v&#x3D;w%u;</span><br><span class="line">    Vec d &#x3D; (u*cos(r1)*r2s + v*sin(r1)*r2s + w*sqrt(1-r2)).norm();</span><br><span class="line">    return obj.e + f.mult(radiance(Ray(x,d),depth,Xi));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å˜é‡ r1 æ˜¯éšæœºæŠ½æ ·åŠçƒæ•£å°„å…‰çº¿ä¸­ä¸€æ¡çš„è§’åº¦ï¼Œå˜é‡ r2 å’Œ r2s æ˜¯ä¸€ä¸ªè·ç¦»ä¸­å¿ƒç‚¹çš„éšæœºé•¿åº¦ã€‚</p>
<p>å˜é‡ w å’Œ u å’Œ v åˆ™åˆ†åˆ«æ˜¯å±€éƒ¨åæ ‡ç³»çš„ä¸‰ä¸ªè½´ã€‚å˜é‡ w å–æœå‘æ³•çº¿çš„æ–¹å‘ã€‚å˜é‡ u æ ¹æ®å˜é‡ w çš„ x è½´åˆ†é‡æ¥å†³å®šæ˜¯ä»¥å“ªä¸ªå‚ç›´è½´æ¥åšå‰ä¹˜å˜é‡ w ï¼Œè¿™æ ·å­ä½¿å¾—å‰ä¹˜ç»“æœæ›´å¥½ï¼ˆæ„Ÿè§‰æ²¡å•¥ç”¨ï¼‰ã€‚å˜é‡ v åˆ™æ˜¯å¦å¤–ä¸¤ä¸ªè½´å‰ä¹˜å¾—åˆ°ã€‚</p>
<p>å˜é‡ d æ˜¯æ±‚å‡ºéšæœºæŠ½æ ·åŠçƒæ•£å°„å…‰çº¿ä¸­ä¸€æ¡å…‰çº¿çš„æ–¹å‘ã€‚ç”±äºå±€éƒ¨åæ ‡ç³»æ˜¯é€šè¿‡ä¸–ç•Œåæ ‡ç³»çš„æœå‘æ³•çº¿å»ºç«‹èµ·æ¥çš„ï¼Œé‚£ä¹ˆåˆ†åˆ«æ±‚å‡ºå…‰çº¿åœ¨å„ä¸ªæ–¹å‘çš„åˆ†é‡ä¹‹åï¼Œåˆèµ·æ¥çš„ç»“æœä¾¿æ˜¯è¯¥å…‰çº¿åœ¨ä¸–ç•Œåæ ‡ç³»ä¸Šçš„åæ ‡ã€‚</p>
<p><code>w*sqrt(1-r2)</code> ä¸­çš„ <code>1-r2</code> è¿™ä¸ªéšæœºå€¼æ˜¯å› ä¸º z è½´è·Ÿ xy è½´ä¸åŒï¼Œéšç€è§’åº¦å¢å¤§ï¼Œ z è½´çš„å€¼æ˜¯å‡å°‘çš„ã€‚</p>
<p>è¿™ç¯‡<a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/148759248">æ–‡ç« </a>è§£é‡Šäº†å˜é‡ r2s çš„å®šä¹‰ã€‚</p>
<p>ä½¿ç”¨äº†æ¦‚ç‡å¯†åº¦å‡½æ•°çš„æ¦‚å¿µã€‚</p>
<p>è¿”å›ç»“æœåˆ™æ˜¯ç»§ç»­é€’å½’ã€‚</p>
<ol>
<li>è®¡ç®—é•œé¢åå°„</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">else if (obj.refl &#x3D;&#x3D; SPEC)            &#x2F;&#x2F; Ideal SPECULAR reflection</span><br><span class="line">    return obj.e + f.mult(radiance(Ray(x,r.d-n*2*n.dot(r.d)),depth,Xi));</span><br></pre></td></tr></table></figure>
<p>é•œé¢åå°„å°±ä¸€å¥ä»£ç ã€‚</p>
<p>ä¸æ¼«åå°„ä¸åŒä¹‹å¤„åœ¨äºé•œé¢åå°„ä¹‹åçš„å…‰çº¿æ–¹å‘ç”± <code>r.d-n*2*n.dot(r.d)</code> æ±‚å¾—ã€‚</p>
<p align="center">
    <img src="https://z3.ax1x.com/2021/08/09/f85BfP.png" width="95%">
    <br />    <small>  </small>
</p>

<ol>
<li>è®¡ç®—æŠ˜å°„ï¼ˆåŒæ ·åŒ…å«åå°„ï¼‰</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">Ray reflRay(x, r.d-n*2*n.dot(r.d));     &#x2F;&#x2F; Ideal dielectric REFRACTION</span><br><span class="line">bool into &#x3D; n.dot(nl)&gt;0;                &#x2F;&#x2F; Ray from outside going in?</span><br><span class="line">double nc&#x3D;1, nt&#x3D;1.5, nnt&#x3D;into?nc&#x2F;nt:nt&#x2F;nc, ddn&#x3D;r.d.dot(nl), cos2t;</span><br><span class="line">if ((cos2t&#x3D;1-nnt*nnt*(1-ddn*ddn))&lt;0)    &#x2F;&#x2F; Total internal reflection</span><br><span class="line">    return obj.e + f.mult(radiance(reflRay,depth,Xi));</span><br><span class="line">Vec tdir &#x3D; (r.d*nnt - n*((into?1:-1)*(ddn*nnt+sqrt(cos2t)))).norm();</span><br><span class="line">double a&#x3D;nt-nc, b&#x3D;nt+nc, R0&#x3D;a*a&#x2F;(b*b), c &#x3D; 1-(into?-ddn:tdir.dot(n));</span><br><span class="line">double Re&#x3D;R0+(1-R0)*c*c*c*c*c,Tr&#x3D;1-Re,P&#x3D;.25+.5*Re,RP&#x3D;Re&#x2F;P,TP&#x3D;Tr&#x2F;(1-P);</span><br><span class="line">return obj.e + f.mult(depth&gt;2 ? (erand48(Xi)&lt;P ?   &#x2F;&#x2F; Russian roulette</span><br><span class="line">    radiance(reflRay,depth,Xi)*RP:radiance(Ray(x,tdir),depth,Xi)*TP) :</span><br><span class="line">    radiance(reflRay,depth,Xi)*Re+radiance(Ray(x,tdir),depth,Xi)*Tr);</span><br></pre></td></tr></table></figure>
<p>ç»ç’ƒæè´¨çš„ç‰©ä½“æ—¢æœ‰æŠ˜å°„ä¹Ÿæœ‰åå°„ï¼Œæ ¹æ®å…¨åå°„åŸç†ï¼Œæœ‰å¯èƒ½ä¼šå‡ºç°å®Œå…¨åå°„çš„æƒ…å†µã€‚æ‰€ä»¥ï¼Œå…ˆè¿›è¡Œåå°„è®¡ç®—ï¼Œç„¶åå†è¿›è¡ŒæŠ˜å°„è®¡ç®—ã€‚</p>
<p>å˜é‡ reflRay ä¸ºåå°„æ–¹å‘å…‰çº¿ã€‚</p>
<p>å˜é‡ into åˆ¤å®šå…‰çº¿æ˜¯ä»å¤–éƒ¨è¿›å…¥ç‰©ä½“ï¼Œè¿˜æ˜¯ä»ç‰©ä½“å†…éƒ¨ç…§å°„å‡ºæ¥ã€‚</p>
<p>å˜é‡ nc ä¸ºç©ºæ°”ä»‹è´¨å¯†åº¦ï¼Œå˜é‡ nt ä¸ºç‰©ä½“ä»‹è´¨å¯†åº¦ã€‚å˜é‡ nnt åˆ™ä¸ºæŠ˜å°„ç‡ï¼Œå˜é‡ ddn ä¸ºå…‰çº¿æ–¹å‘ä¸æœå‘æ³•çº¿è§’åº¦çš„ä½™å¼¦å€¼ã€‚</p>
<p>è¡¨è¾¾å¼ <code>(cos2t=1-nnt*nnt*(1-ddn*ddn))&lt;0</code> åˆ¤æ–­æ˜¯å¦å…¨åå°„ã€‚å¦‚æœæ»¡è¶³å…¨åå°„ï¼Œåˆ™ä¸ç”¨è®¡ç®—æŠ˜å°„ï¼Œç›´æ¥è¿”å›åå°„é€’å½’è°ƒç”¨ã€‚</p>
<p>æ¥ä¸‹æ¥è®¡ç®—æŠ˜å°„éƒ¨åˆ†ã€‚</p>
<p>å˜é‡ tdir ä¸º æŠ˜å°„å…‰æ–¹å‘ã€‚</p>
<p align="center">
    <img src="https://img-blog.csdnimg.cn/20200824003230970.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2cxMWQxMTE=,size_16,color_FFFFFF,t_70#pic_center" width="95%">
    <br />    <small>  </small>
</p>

<p>æ¥ä¸‹æ¥ä½¿ç”¨è²æ¶…å°”é¡¹æ¥è®¡ç®—æ ¡å‡†ä¹‹åçš„æŠ˜å°„å…‰çš„åå°„æ¯”ã€‚</p>
<p>å˜é‡ Re ä¸ºæŠ˜å°„å…‰çš„è²æ¶…å°”é¡¹ã€‚</p>
<p>æœ€åï¼Œå†è¿›è¡Œä¸€æ¬¡ä¿„ç½—æ–¯è½®ç›˜èµŒï¼Œå˜é‡ RP æ˜¯äº§ç”Ÿè²æ¶…å°”é¡¹æ•ˆæœçš„æ¦‚ç‡ï¼Œå˜é‡ TP æ˜¯ä¸äº§ç”Ÿè²æ¶…å°”é¡¹æ•ˆæœçš„æ¦‚ç‡ã€‚å½“æ·±åº¦å¤§äº2æ—¶ï¼Œå¯åŠ¨ä¿„ç½—æ–¯è½®ç›˜èµŒï¼Œåˆ¤æ–­ä¸ºçœŸåˆ™å¯ç”¨åå°„è®¡ç®—ï¼ˆå åŠ è²æ¶…å°”é¡¹ï¼‰ï¼Œåˆ¤æ–­ä¸ºå‡åˆ™è¿›è¡ŒæŠ˜å°„è®¡ç®—ï¼ˆå åŠ å¯¹ç«‹æ¯”ä¾‹ï¼‰ã€‚å½“æ·±åº¦å°äº2æ—¶ï¼Œåˆ™æ˜¯åå°„å’ŒæŠ˜å°„ä¸¤è€…çš„å åŠ æ•ˆæœè®¡ç®—ï¼ˆå½“ç„¶æ²¡æœ‰ä¿„ç½—æ–¯è½®ç›˜èµŒï¼‰ã€‚</p>
<ol>
<li>å…¶ä»–</li>
</ol>
<p>å¯ä»¥çœ‹åˆ°ï¼Œåœ¨æ¯ä¸ª return è¯­å¥ä¸Šï¼Œéƒ½æ˜¯å½“å‰ç›¸äº¤ç‚¹çš„ç‰©ä½“çš„è¾å°„å€¼åŠ ä¸Šç‰©ä½“é¢œè‰²ä¹˜ä»¥ä¸‹ä¸€æ¬¡å…‰çº¿è¿½è¸ªè¿”å›ç»“æœçš„å€¼ã€‚è¿™æ ·å­ä¸€ç›´é€’å½’åˆ°æœ€åä¸€å±‚ï¼Œè¿™æ ·å­åé€’å½’çš„æ—¶å€™ï¼Œå°±ä¼šå°†æºå¤´çš„ç»“æœå åŠ å›æ¥ã€‚</p>


                            <!-- Meta -->
                            <div class="post-meta">
                                <hr>
                                <br>
                                <div class="post-tags">
                                    
                                        

<a href="/tags/Ray-Tracing/">#Ray Tracing</a>


                                            
                                </div>
                                <div class="post-date">
                                    
                                        2021-09-03
                                    
                                </div>
                            </div>
                    </div>

                    <!-- Comments -->
                    <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                        <!-- Disqus Comments -->


                    </div>
                </div>
            </div>
        </article>
</section>

<!-- Image viewer-->

    <!-- Custom picture view-->
    <link href="/css/viewer.min.css" rel="stylesheet" />
    <script
      src="/js/viewer.min.js"
      type="text/javascript"
      charset="utf-8"
    ></script>
    
    <script type="text/javascript">
      // set image viewer
      Viewer.setDefaults({
        zoomRatio: [0.5],
        navbar: false,
        toolbar: false,
        button: false,
        title: [2, (image, imageData) => `${image.alt}`],
        show: function() {
          this.viewer.zoomTo(0.5);
        }
      });
      var imageList = document.getElementsByTagName("img");
      Array.prototype.forEach.call(imageList, element => {
        var viewer = new Viewer(element);
      });
    </script>

    

<!-- TOC -->

    <aside id="article-toc" role="navigation" class="fixed">
        <div id="article-toc-inner">
            <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%80%E3%80%81%E7%89%B9%E5%BE%81"><span class="toc-text">ä¸€ã€ç‰¹å¾</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%8C%E3%80%81%E6%BA%90%E7%A0%81"><span class="toc-text">äºŒã€æºç </span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%89%E3%80%81%E7%94%A8%E6%B3%95"><span class="toc-text">ä¸‰ã€ç”¨æ³•</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9B%9B%E3%80%81%E7%BB%86%E8%8A%82"><span class="toc-text">å››ã€ç»†èŠ‚</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%94%E3%80%81%E6%89%A9%E5%B1%95"><span class="toc-text">äº”ã€æ‰©å±•</span></a></li></ol>
        </div>
    </aside>

    <!-- Scripts -->
    <script type="text/javascript">
    console.log("Â© chaguake ğŸ™‹ 2021-" + new Date().getFullYear());
</script>
  
    <!-- Google Analytics -->
    

    <!-- Service Worker -->
    <!-- if using service worker -->

    
<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        tex2jax: {
            inlineMath: [ ["$","$"], ["\\(","\\)"] ],
            skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code'],
            processEscapes: true
        }
    });
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax();
        for (var i = 0; i < all.length; ++i)
            all[i].SourceElement().parentNode.className += ' has-jax';
    });
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-MML-AM_CHTML"></script>
</body>

</html>